<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>HealthTrack - 家庭</title>
    <link rel="stylesheet" href="../assets/styles.css" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div>
          <div class="title">家庭</div>
          <div class="subtitle"><a class="link" href="../index.html">返回主菜单</a></div>
        </div>
        <span class="pill" id="currentUserPill"></span>
      </div>

      <div class="panel">
        <div class="grid">
          <div class="col-12">
            <div class="notice" id="notice" style="display:none;"></div>
          </div>

          <div class="col-5">
            <div style="font-weight:700; margin-bottom:8px;">我的家庭成员</div>
            <div class="subtitle">提示：要“登录家庭成员账号”，请在登录页输入该成员的 userId。</div>
            <div style="height:10px;"></div>
            <button class="btn" id="refreshBtn">刷新成员列表</button>
            <table>
              <thead><tr><th>成员</th><th>组</th><th class="th-actions">操作</th></tr></thead>
              <tbody id="memberTbody"></tbody>
            </table>
          </div>

          <div class="col-7">
            <div style="font-weight:700; margin-bottom:8px;">成员状况与挑战</div>
            <div class="subtitle" id="targetHint">请选择一位家庭成员。</div>

            <div style="height:10px;"></div>
            <div class="row">
              <button class="btn primary" id="loadHealthBtn">查看健康记录</button>
              <button class="btn primary" id="loadChallengeBtn">查看挑战</button>
            </div>

            <div style="height:14px;"></div>
            <div style="font-weight:700;">健康记录（最近）</div>
            <table>
              <thead><tr><th>指标</th><th>数值</th><th>时间</th><th>备注</th></tr></thead>
              <tbody id="healthTbody"></tbody>
            </table>

            <div style="height:14px;"></div>
            <div style="font-weight:700;">挑战（参与情况）</div>
            <table>
              <thead><tr><th>目标</th><th>日期</th><th>进度</th><th>完成</th></tr></thead>
              <tbody id="challengeTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { api, getCurrentUserId } from "../assets/api.js";

      const pill = document.getElementById("currentUserPill");
      const notice = document.getElementById("notice");
      const refreshBtn = document.getElementById("refreshBtn");
      const memberTbody = document.getElementById("memberTbody");

      const targetHint = document.getElementById("targetHint");
      const loadHealthBtn = document.getElementById("loadHealthBtn");
      const loadChallengeBtn = document.getElementById("loadChallengeBtn");
      const healthTbody = document.getElementById("healthTbody");
      const challengeTbody = document.getElementById("challengeTbody");

      let targetUserId = null;

      function show(msg, kind) {
        notice.style.display = "block";
        notice.className = `notice ${kind || ""}`;
        notice.textContent = msg;
      }

      function userIdOrRedirect() {
        const id = getCurrentUserId();
        if (!id) { window.location.href = "../login.html"; return null; }
        pill.textContent = `已登录 userId：${id}`;
        return id;
      }

      async function refreshMembers() {
        const viewerUserId = userIdOrRedirect();
        if (!viewerUserId) return;
        const res = await api.family.members(viewerUserId);
        const items = res.items || [];
        if (items.length === 0) {
          memberTbody.innerHTML = "";
          show("当前账号不在任何家庭组中。", "error");
          return;
        }
        memberTbody.innerHTML = items.map(m => `
          <tr>
            <td>${m.fullName}（userId=${m.userId}）</td>
            <td>${m.groupName || ("组#" + m.familyGroupId)}</td>
            <td class="td-actions"><button class="btn" data-uid="${m.userId}" data-name="${encodeURIComponent(m.fullName)}">选择</button></td>
          </tr>
        `).join("");
        memberTbody.querySelectorAll("button[data-uid]").forEach(btn => {
          btn.addEventListener("click", () => {
            targetUserId = Number(btn.dataset.uid);
            const name = decodeURIComponent(btn.dataset.name);
            targetHint.textContent = `已选择：${name}（userId=${targetUserId}）`;
            healthTbody.innerHTML = "";
            challengeTbody.innerHTML = "";
          });
        });
      }

      async function loadHealth() {
        const viewerUserId = userIdOrRedirect();
        if (!viewerUserId) return;
        if (!targetUserId) return show("请先选择家庭成员。", "error");
        const res = await api.family.memberHealthRecords({ viewerUserId, targetUserId }, 50);
        const rows = res.items || [];
        healthTbody.innerHTML = rows.map(r => `
          <tr>
            <td>${r.metricName || r.metricCode}</td>
            <td>${r.value} ${r.unit || ""}</td>
            <td>${r.recordedAt}</td>
            <td>${r.note || ""}</td>
          </tr>
        `).join("");
      }

      async function loadChallenges() {
        const viewerUserId = userIdOrRedirect();
        if (!viewerUserId) return;
        if (!targetUserId) return show("请先选择家庭成员。", "error");
        const res = await api.family.memberChallenges({ viewerUserId, targetUserId });
        const rows = res.items || [];
        challengeTbody.innerHTML = rows.map(r => `
          <tr>
            <td>${r.goalText}</td>
            <td>${r.startDate} → ${r.endDate}</td>
            <td>${r.progressValue}</td>
            <td>${r.isCompleted ? "是" : "否"}</td>
          </tr>
        `).join("");
      }

      refreshBtn.addEventListener("click", async () => {
        try { await refreshMembers(); show("已刷新成员列表。", "ok"); } catch (e) { show(e.message, "error"); }
      });
      loadHealthBtn.addEventListener("click", async () => {
        try { await loadHealth(); show("已加载健康记录。", "ok"); } catch (e) { show(e.message, "error"); }
      });
      loadChallengeBtn.addEventListener("click", async () => {
        try { await loadChallenges(); show("已加载挑战列表。", "ok"); } catch (e) { show(e.message, "error"); }
      });

      (async () => {
        try {
          userIdOrRedirect();
          await refreshMembers();
        } catch (e) {
          show(e.message, "error");
        }
      })();
    </script>
  </body>
</html>


