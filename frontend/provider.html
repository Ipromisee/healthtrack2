<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>HealthTrack - Provider 门户</title>
    <link rel="stylesheet" href="./assets/styles.css" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div>
          <div class="title">Provider 门户</div>
          <div class="subtitle">预约管理</div>
        </div>
        <div class="row">
          <span class="pill" id="currentProviderPill">未登录</span>
          <button class="btn danger" id="signOutBtn">退出登录</button>
        </div>
      </div>

      <div class="panel">
        <div class="grid">
          <div class="col-12 row" style="justify-content: space-between;">
            <div style="font-weight:700;">我的预约</div>
            <button class="btn" id="refreshBtn">刷新</button>
          </div>
          <div class="col-12">
            <div class="notice" id="notice" style="display:none;"></div>
          </div>

          <div class="col-12">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>用户</th>
                  <th>时间</th>
                  <th>类型</th>
                  <th>状态</th>
                  <th>取消原因</th>
                  <th class="th-actions">操作</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>

          <div class="col-12" style="height:10px;"></div>

          <div class="col-12 row" style="justify-content: space-between;">
            <div style="font-weight:700;">病人状况</div>
            <button class="btn" id="patientRefreshBtn">刷新病人列表</button>
          </div>

          <div class="col-4">
            <label>选择病人</label>
            <select id="patientSelect"></select>
            <div style="height:10px;"></div>
            <button class="btn primary" id="loadPatientBtn">查看健康记录</button>
          </div>

          <div class="col-8">
            <div class="subtitle" id="patientHint">选择病人后可查看最近健康记录。</div>
            <table>
              <thead>
                <tr>
                  <th>指标</th>
                  <th>数值</th>
                  <th>时间</th>
                  <th>备注</th>
                </tr>
              </thead>
              <tbody id="patientTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { api, getCurrentProviderId, clearCurrentUser } from "./assets/api.js";

      const pill = document.getElementById("currentProviderPill");
      const signOutBtn = document.getElementById("signOutBtn");
      const refreshBtn = document.getElementById("refreshBtn");
      const notice = document.getElementById("notice");
      const tbody = document.getElementById("tbody");
      const cancelReasonInput = document.getElementById("cancelReasonInput");
      const patientRefreshBtn = document.getElementById("patientRefreshBtn");
      const patientSelect = document.getElementById("patientSelect");
      const loadPatientBtn = document.getElementById("loadPatientBtn");
      const patientTbody = document.getElementById("patientTbody");
      const patientHint = document.getElementById("patientHint");

      function show(msg, kind) {
        notice.style.display = "block";
        notice.className = `notice ${kind || ""}`;
        notice.textContent = msg;
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      // Surface any JS errors to the UI (avoid "no response" feeling)
      window.addEventListener("error", (ev) => {
        show(`页面脚本错误：${ev.message}`, "error");
      });
      window.addEventListener("unhandledrejection", (ev) => {
        const m = ev?.reason?.message || String(ev.reason);
        show(`请求失败：${m}`, "error");
      });

      function providerIdOrRedirect() {
        const id = getCurrentProviderId();
        if (!id) {
          window.location.href = "./login.html";
          return null;
        }
        pill.textContent = `已登录 providerId：${id}`;
        return id;
      }

      function render(rows, providerId) {
        tbody.innerHTML = rows.map(r => `
          <tr>
            <td>${r.appointmentId}</td>
            <td>${r.userName}（${r.userHealthId}）</td>
            <td>${r.scheduledAt}</td>
            <td>${r.appointmentType}</td>
            <td>${r.status}</td>
            <td>${r.cancelReason || ""}</td>
            <td class="td-actions">
              ${r.status === "SCHEDULED" ? `<button class="btn danger" data-id="${r.appointmentId}">取消</button>` : ""}
            </td>
          </tr>
        `).join("");

        tbody.querySelectorAll("button[data-id]").forEach(btn => {
          btn.addEventListener("click", async () => {
            const appointmentId = Number(btn.dataset.id);
            const reason = (cancelReasonInput?.value || "").trim() || "医生临时无法出诊";
            show("正在取消预约，请稍候…", "");
            try {
              btn.disabled = true;
              await api.provider.cancelAppointment({ providerId, appointmentId, reason });
              await refresh();
              show("已取消预约。", "ok");
            } catch (e) {
              show(e?.message || String(e), "error");
            } finally {
              btn.disabled = false;
            }
          });
        });
      }

      async function refresh() {
        const providerId = providerIdOrRedirect();
        if (!providerId) return;
        const res = await api.provider.appointments(providerId);
        render(res.items || [], providerId);
      }

      async function refreshPatients() {
        const providerId = providerIdOrRedirect();
        if (!providerId) return;
        const res = await api.provider.patients(providerId);
        const items = res.items || [];
        if (items.length === 0) {
          patientSelect.innerHTML = "";
          patientHint.textContent = "暂无病人（需要先有用户预约到你名下）。";
          patientTbody.innerHTML = "";
          return;
        }
        patientSelect.innerHTML = items.map(u => `<option value="${u.userId}">${u.fullName}（${u.healthId}）</option>`).join("");
        patientHint.textContent = "已加载病人列表。";
      }

      async function loadPatientHealthRecords() {
        const providerId = providerIdOrRedirect();
        if (!providerId) return;
        const userId = Number(patientSelect.value);
        if (!userId) return show("请选择病人。", "error");
        const res = await api.provider.patientHealthRecords(providerId, userId, 50);
        const rows = res.items || [];
        patientTbody.innerHTML = rows.map(r => `
          <tr>
            <td>${r.metricName || r.metricCode}</td>
            <td>${r.value} ${r.unit || ""}</td>
            <td>${r.recordedAt}</td>
            <td>${r.note || ""}</td>
          </tr>
        `).join("");
        patientHint.textContent = `已展示最近 ${rows.length} 条健康记录。`;
      }

      refreshBtn.addEventListener("click", async () => {
        try { await refresh(); show("已刷新。", "ok"); } catch (e) { show(e.message, "error"); }
      });

      patientRefreshBtn.addEventListener("click", async () => {
        try { await refreshPatients(); show("病人列表已刷新。", "ok"); } catch (e) { show(e.message, "error"); }
      });

      loadPatientBtn.addEventListener("click", async () => {
        try { await loadPatientHealthRecords(); show("已加载健康记录。", "ok"); } catch (e) { show(e.message, "error"); }
      });

      signOutBtn.addEventListener("click", () => {
        clearCurrentUser();
        window.location.href = "./login.html";
      });

      (async () => {
        try {
          providerIdOrRedirect();
          await refresh();
          await refreshPatients();
        } catch (e) {
          show(e.message, "error");
        }
      })();
    </script>
  </body>
</html>


